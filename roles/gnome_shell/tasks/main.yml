###############################################################################
# Install Gnome shell on wayland
###############################################################################

- name: Install wayland, gnome-shell and gdm
  pacman:
    name:
      - wayland
      - gdm
      - gnome-shell
  tags:
    - gnome_shell

- name: Disable gnome xsession
  command: mv /usr/share/xsessions/gnome.desktop /usr/share/xsessions/gnome.desktop.disabled
  args:
    removes: /usr/share/xsessions/gnome.desktop
  tags:
    - gnome_shell

- name: Try to find out host keymap
  command: localectl status
  delegate_to: localhost
  failed_when: false
  changed_when: false
  when: keymap|default('', true)|length == 0
  register: localectl_status
  tags:
    - gnome_shell
    - keymap

- name: Store found host keymap
  set_fact:
    keymap: "{{ localectl_status.stdout | regex_search('Keymap:\\s*(.*)$', '\\1', multiline=True) | first }}"
  when: (keymap | default('', true) | length == 0) and (localectl_status.rc == 0)
  tags:
    - gnome_shell
    - keymap

- name: Set gnome keyboard layout
  dconf:
    key: "/org/gnome/desktop/input-sources/sources"
    value: "[('xkb', '{{ keymap }}')]"
  when: keymap|default('', true)|length != 0
  tags:
    - gnome_shell
    - keymap

- name: Disable sleep on inactivity
  # Sleep on inactivity can be a problem when installation with Ansible is slow
  # The sleep is completely disabled here
  # Another possibility would be to enlarge the timeout
  # See https://wiki.archlinux.org/index.php/GNOME#Power
  dconf:
    key: "/org/gnome/settings-daemon/plugins/power/sleep-inactive-ac-type"
    value: "'nothing'"
  tags:
    - gnome_shell
    - gnome_disable_sleep

- name: Disable idle delay
  # Sleep on inactivity can be a problem when installation with Ansible is slow
  # "Idle time" is disabled by setting it to 0
  dconf:
    key: "/org/gnome/desktop/session/idle-delay"
    value: "0"
  tags:
    - gnome_shell
    - gnome_disable_sleep

- name: Enable and start gdm
  systemd:
    name: gdm
    state: started
    enabled: yes
  tags:
    - gnome_shell

- name: Install useful gnome desktop applications
  pacman:
    name:
      - gnome-shell-extension-appindicator
      - xdg-desktop-portal-gtk
      - xdg-user-dirs
      - nautilus
      - tumbler
      - ffmpegthumbnailer
      - raw-thumbnailer
      - gnome-epub-thumbnailer
      - gnome-control-center
      - gnome-books
      - gcompris-qt
  tags:
    - gnome_shell
    - apps

- name: Enable appindicator by default
  # Proper name of the appindicator extension needed
  # Can be found in PKGBUILD of package:
  # appindicatorsupport@rgcjonas.gmail.com
  dconf:
    key: "/org/gnome/shell/enabled-extensions"
    value: "['appindicatorsupport@rgcjonas.gmail.com']"
  tags:
    - gnome_shell
    - apps

# org.gnome.books night-mode true
